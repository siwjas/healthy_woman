<% content_for :breadcrumbs do %>
  <%= render "shared/breadcrumb", current: "Detalhes do Ciclo Menstrual", parents: [
    {label: "Calculadoras de Ciclo Menstrual", url: account_team_menstrual_cycle_calculators_path(current_team)}
  ] %>
<% end %>

<% content_for :actions do %>
  <%= link_to "Editar", edit_account_menstrual_cycle_calculator_path(@menstrual_cycle_calculator), class: "btn btn-secondary mr-2" %>
  <%= button_to "Excluir", account_menstrual_cycle_calculator_path(@menstrual_cycle_calculator), method: :delete, data: { confirm: "Tem certeza que deseja excluir esta calculadora?" }, class: "btn btn-danger" %>
<% end %>

<div class="container mx-auto px-4 py-8">
  <h1 class="text-2xl font-bold mb-6">Detalhes do Ciclo Menstrual</h1>

  <div class="bg-white shadow overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:px-6">
      <h3 class="text-lg leading-6 font-medium text-gray-900">Informações do Ciclo</h3>
      <p class="mt-1 max-w-2xl text-sm text-gray-500">Detalhes e previsões baseadas no seu ciclo menstrual.</p>
    </div>
    <div class="border-t border-gray-200">
      <dl>
        <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">Data da última menstruação</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2"><%= @menstrual_cycle_calculator.last_period_date.strftime('%d/%m/%Y') %></dd>
        </div>
        <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">Duração do ciclo</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2"><%= @menstrual_cycle_calculator.cycle_length %> dias</dd>
        </div>
        <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">Duração da menstruação</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2"><%= @menstrual_cycle_calculator.period_length %> dias</dd>
        </div>
        <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">Próxima menstruação</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2"><%= @menstrual_cycle_calculator.next_period_date.strftime('%d/%m/%Y') %></dd>
        </div>
        <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">Janela fértil</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2"><%= @menstrual_cycle_calculator.fertile_window_start.strftime('%d/%m/%Y') %> até <%= @menstrual_cycle_calculator.fertile_window_end.strftime('%d/%m/%Y') %></dd>
        </div>
        <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">Dia da ovulação</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2"><%= @menstrual_cycle_calculator.ovulation_date.strftime('%d/%m/%Y') %></dd>
        </div>
        <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">Observações</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2"><%= @menstrual_cycle_calculator.notes.present? ? @menstrual_cycle_calculator.notes : "Nenhuma observação registrada" %></dd>
        </div>
      </dl>
    </div>
  </div>

  <div class="mt-8 bg-white shadow overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:px-6">
      <h3 class="text-lg leading-6 font-medium text-gray-900">Calendário do Ciclo</h3>
      <p class="mt-1 max-w-2xl text-sm text-gray-500">Visualização das fases do seu ciclo menstrual.</p>
    </div>
    <div class="border-t border-gray-200 px-4 py-5">
      <div class="flex flex-wrap justify-center">
        <% 
          today = Date.today
          start_date = @menstrual_cycle_calculator.last_period_date
          cycle_length = @menstrual_cycle_calculator.cycle_length
          period_length = @menstrual_cycle_calculator.period_length
          fertile_start = @menstrual_cycle_calculator.fertile_window_start
          fertile_end = @menstrual_cycle_calculator.fertile_window_end
          ovulation_date = @menstrual_cycle_calculator.ovulation_date
          next_period = @menstrual_cycle_calculator.next_period_date
          
          # Mostrar dois ciclos completos
          days_to_show = cycle_length * 2
          
          days_to_show.times do |i|
            current_date = start_date + i.days
            
            # Determinar a fase do ciclo
            phase_class = ""
            phase_text = ""
            
            if current_date >= start_date && current_date < (start_date + period_length.days)
              phase_class = "bg-red-100 border-red-500"
              phase_text = "Menstruação"
            elsif current_date >= fertile_start && current_date <= fertile_end
              phase_class = "bg-green-100 border-green-500"
              phase_text = "Fértil"
            elsif current_date == ovulation_date
              phase_class = "bg-blue-100 border-blue-500"
              phase_text = "Ovulação"
            elsif current_date >= (next_period - 7.days) && current_date < next_period
              phase_class = "bg-yellow-100 border-yellow-500"
              phase_text = "Pré-menstrual"
            else
              phase_class = "bg-gray-100 border-gray-300"
              phase_text = "Fase folicular"
            end
            
            # Destacar o dia atual
            if current_date == today
              phase_class += " ring-2 ring-indigo-500"
            end
        %>
          <div class="w-16 h-16 m-1 flex flex-col justify-center items-center border rounded-md <%= phase_class %>">
            <div class="text-xs font-semibold"><%= current_date.strftime('%d/%m') %></div>
            <div class="text-xs mt-1"><%= phase_text %></div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="mt-8">
    <%= link_to "Voltar para a lista", account_team_menstrual_cycle_calculators_path(current_team), class: "text-indigo-600 hover:text-indigo-900" %>
  </div>
</div>
